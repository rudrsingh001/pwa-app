<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b66ff">
  <link rel="icon" href="icons/icon-192.png">

  <style>
    body{
      margin:0;font-family:Arial,sans-serif;background:#f5f7fb;
      padding-bottom:72px; /* banner space */
    }
    header{background:#0b66ff;color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:900;}
    .wrap{max-width:520px;margin:18px auto;padding:0 14px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.12);padding:18px;}
    .tag{margin-top:8px;font-size:13px;color:#6b7280;text-align:center;}
    .stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .chip{
      flex:1;min-width:160px;background:#fafafa;
      border:1px solid #e5e7eb;border-radius:14px;padding:10px 12px;
      font-weight:900;font-size:14px;color:#111827;
    }
    .chip b{color:#0b66ff;}
    .btn-group{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap;}
    .btn-group a{flex:1;min-width:160px;text-decoration:none;}
    button{
      width:100%;padding:14px;border:none;border-radius:14px;
      font-size:15px;font-weight:900;cursor:pointer;
    }
    .btn-ad{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb;}
    .btn-spin{background:#0b66ff;color:#fff;}
    .btn-withdraw{background:#111827;color:#fff;}
    .logout{margin-top:14px;background:#fee2e2;color:#991b1b;}

    /* Splash overlay */
    .splash{
      position:fixed;inset:0;background:#0b66ff;color:#fff;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      z-index:9999;
    }
    .splash img{width:90px;height:90px;border-radius:22px;background:#fff;padding:10px;}
    .splash h2{margin:14px 0 4px;font-size:22px;}
    .splash p{margin:6px 0;opacity:.9;font-weight:700;}
    /* Bottom banner */
    .banner{
      position:fixed;bottom:0;left:0;right:0;height:60px;
      background:#e5e7eb;border-top:1px solid #d1d5db;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;z-index:999;
    }
    .footer-links{margin-top:12px;text-align:center;font-size:13px;}
    .footer-links a{color:#0b66ff;text-decoration:none;font-weight:800;}
  </style>
</head>

<body>

  <!-- Splash -->
  <div id="splash" class="splash">
    <img src="icons/icon-192.png" alt="App Icon">
    <h2>My PWA App</h2>
    <p>Loading...</p>
  </div>

  <header>Home</header>

  <div class="wrap">
    <div class="card">
      <div style="font-size:18px;font-weight:900;">
        Welcome, <span id="nm">User</span> âœ…
      </div>
      <div class="tag">Wallet, spins & spin unlock yahin se control hoga.</div>

      <div class="stats">
        <div class="chip">Wallet: <b id="wallet">0</b> ðŸª™</div>
        <div class="chip">Spins left: <b id="left">0</b>/5</div>
      </div>

      <div class="btn-group">
        <button id="adBtn" class="btn-ad" onclick="watchAd()">ðŸŽ¬ Watch Ad to Unlock Spin</button>

        <a href="wheel.html">
          <button id="spinBtn" class="btn-spin">ðŸŽ¡ Spin Wheel</button>
        </a>

        <a href="withdraw.html">
          <button class="btn-withdraw">ðŸ’¸ Withdraw</button>
        </a>
      </div>

      <button class="logout" onclick="logout()">Logout</button>

      <div class="footer-links">
        <a href="rules.html">Rules</a> |
        <a href="privacy.html">Privacy</a> |
        <a href="terms.html">Terms</a>
      </div>
    </div>
  </div>

  <!-- Bottom Banner (UI placeholder) -->
  <div class="banner">ðŸ“¢ Banner Ad (AdMob)</div>

<script>
  // ---------- Login protect ----------
  try{
    if (localStorage.getItem("isLoggedIn") !== "yes"){
      window.location.href = "login.html";
    }
  } catch(e){}

  // show name
  try{
    document.getElementById("nm").innerText = localStorage.getItem("loginUser") || "User";
  } catch(e){}

  // ---------- Shared keys ----------
  const LS = {
    WALLET: "walletCoins",
    DAY: "spinDay",
    COUNT: "spinCount",
    UNLOCK_UNTIL: "spinUnlockUntil",
    AD_INDEX: "adIndex",
    FREE_USED: "freeSpinUsed"
  };

  const DAILY_LIMIT = 5;
  const AD_SEQ = [15,15,30,30,15]; // seconds

  function todayKey(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function getWallet(){
    return parseInt(localStorage.getItem(LS.WALLET) || "0", 10);
  }
  function setWallet(v){
    localStorage.setItem(LS.WALLET, String(v));
  }

  function getSpinCountToday(){
    const day = localStorage.getItem(LS.DAY);
    const t = todayKey();
    if (day !== t){
      localStorage.setItem(LS.DAY, t);
      localStorage.setItem(LS.COUNT, "0");
      localStorage.setItem(LS.AD_INDEX, "0");
      localStorage.removeItem(LS.FREE_USED);
      return 0;
    }
    return parseInt(localStorage.getItem(LS.COUNT) || "0", 10);
  }

  function spinsLeft(){
    return Math.max(0, DAILY_LIMIT - getSpinCountToday());
  }

  function isUnlocked(){
    const until = parseInt(localStorage.getItem(LS.UNLOCK_UNTIL) || "0", 10);
    return Date.now() < until;
  }

  function formatUnlockSec(){
    const until = parseInt(localStorage.getItem(LS.UNLOCK_UNTIL) || "0", 10);
    return Math.max(0, Math.floor((until - Date.now())/1000));
  }

  function getAdIndex(){
    let i = parseInt(localStorage.getItem(LS.AD_INDEX) || "0", 10);
    if (i >= AD_SEQ.length) i = 0;
    return i;
  }

  let adRunning = false;

  function watchAd(){
    if (adRunning) return;

    if (spinsLeft() <= 0){
      alert("Daily limit reached (5/5). Kal phir try karo âœ…");
      updateUI();
      return;
    }

    // already unlocked
    if (isUnlocked()){
      alert("Already unlocked âœ… Spin Wheel kholo.");
      updateUI();
      return;
    }

    adRunning = true;

    const adBtn = document.getElementById("adBtn");
    let idx = getAdIndex();
    let sec = AD_SEQ[idx];

    // demo fail handling: 1 retry then 1 free unlock per day
    const failChance = 0.08; // small
    let failedOnce = false;

    function success(){
      localStorage.setItem(LS.UNLOCK_UNTIL, String(Date.now() + 2*60*1000));
      localStorage.setItem(LS.AD_INDEX, String(idx + 1));

      // bonus for 30s
      if (sec === 30){
        setWallet(getWallet() + 5);
      }

      adRunning = false;
      alert("Spin unlocked âœ… Ab Spin Wheel kholo!");
      updateUI();
    }

    function fail(){
      if (!failedOnce){
        failedOnce = true;
        alert("Ad failed, retrying...");
        startCountdown(); // retry same ad
        return;
      }

      // one free unlock per day
      if (!localStorage.getItem(LS.FREE_USED)){
        localStorage.setItem(LS.FREE_USED, "1");
        localStorage.setItem(LS.UNLOCK_UNTIL, String(Date.now() + 2*60*1000));
        adRunning = false;
        alert("Free spin unlocked (1 time) âœ…");
        updateUI();
        return;
      }

      adRunning = false;
      alert("Try later âŒ");
      updateUI();
    }

    function startCountdown(){
      let t = sec;
      adBtn.innerText = `Ad playing... ${t}s`;
      adBtn.disabled = true;

      const timer = setInterval(()=>{
        t--;
        adBtn.innerText = `Ad playing... ${t}s`;
        if (t <= 0){
          clearInterval(timer);

          // simulate random fail
          if (Math.random() < failChance) fail();
          else success();
        }
      }, 1000);
    }

    startCountdown();
  }

  function updateUI(){
    const walletEl = document.getElementById("wallet");
    const leftEl = document.getElementById("left");
    const adBtn = document.getElementById("adBtn");
    const spinBtn = document.getElementById("spinBtn");

    walletEl.innerText = getWallet();
    leftEl.innerText = spinsLeft();

    // lock spin until unlocked
    if (spinsLeft() <= 0){
      adBtn.disabled = true;
      adBtn.innerText = "Daily limit reached âœ…";
      spinBtn.disabled = true;
      spinBtn.innerText = "ðŸŽ¡ Spin Wheel (Locked)";
      return;
    }

    if (isUnlocked()){
      const s = formatUnlockSec();
      adBtn.disabled = true;
      adBtn.innerText = `âœ… Spin Unlocked (${s}s left)`;
      spinBtn.disabled = false;
      spinBtn.innerText = "ðŸŽ¡ Spin Wheel";
    } else {
      adBtn.disabled = false;
      adBtn.innerText = "ðŸŽ¬ Watch Ad to Unlock Spin";
      spinBtn.disabled = true;
      spinBtn.innerText = "ðŸŽ¡ Spin Wheel (Locked)";
    }
  }

  function logout(){
    localStorage.removeItem("isLoggedIn");
    localStorage.removeItem("loginUser");
    window.location.href = "login.html";
  }

  // Splash hide (always)
  window.addEventListener("load", ()=>{
    const sp = document.getElementById("splash");
    if (sp) sp.style.display = "none";
  });
  setTimeout(()=>{
    const sp = document.getElementById("splash");
    if (sp) sp.style.display = "none";
  }, 1200);

  // Refresh UI
  updateUI();
  setInterval(updateUI, 1000);

  // Service worker (optional)
  try{
    if ("serviceWorker" in navigator){
      navigator.serviceWorker.register("service-worker.js");
    }
  } catch(e){}
</script>

</body>
</html>
